<%# HEADER PARTIAL %>
<div class="box-size">
  <h2 class="mb-3">
    <i class="fa-solid fa-wallet" style="color: #000000ff;"></i>
    Budget
  </h2>
</div>
<%# HEADER PARTIAL %>
<%# Define current month's date range %>
<% start_of_month = Date.current.beginning_of_month %>
<% end_of_month = Date.current.end_of_month %>
<%# Prepare colors for categories excluding "Income" %>
<% category_colors = {} %>
<% @category_totals.each_with_index do |(title, _), index| %>
  <% next if title == "Income" %>
  <% category_colors[title] = Category::COLORS[index] %>
<% end %>
<%# Filter transactions by date range (this month only) %>
<% filtered_transactions = @transactions.transform_values do |transactions| %>
  <%transactions.select { |t| t.date >= start_of_month && t.date <= end_of_month }%>
<% end %>
<%# Sort categories by total amount spent this month (excluding Income and empty) %>
<% sorted_transactions = filtered_transactions.reject { |category, transactions| category.title == "Income" || transactions.empty? }
                                              .sort_by { |category, transactions| -transactions.sum(&:amount) } %>
<div class="box-size">
  <% sorted_transactions.each do |(category, transactions)| %>
    <% next if category.title == "Income" || transactions.empty? %>
    <% total = transactions.sum(&:amount) %>
    <% limit = category.limit %>
    <% bar_color = category_colors[category.title] || "#007bff" %>
    <div class="mb-4 p-3 bg-white rounded-4 shadow-sm">
      <div class="d-flex justify-content-between align-items-center mb-1">
        <div class="d-flex align-items-center">
          <div class="me-2">
            <i class="fa fa-circle" style="color: <%= bar_color %>;"></i>
          </div>
          <strong><%= category.title %></strong>
        </div>
        <% if limit.present? %>
          <% remaining = [limit - total, 0].max %>
          <% percentage = [(total.to_f / limit) * 100, 100].min %>
          <div style="color: #000000ff">Remaining – ¥<%= number_with_delimiter(remaining) %></div>
        <% else %>
          <%# update function  %>
          <div type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasLimit-<%= category.id %>" aria-controls="offcanvasLimit">
            <h5 class="text-start badge bg-primary text-wrap" style="color: #ffffffff; ">Set category limit</h5>
          </div>
          <div class="offcanvas offcanvas-bottom" tabindex="-1" id="offcanvasLimit-<%= category.id %>" aria-labelledby="offcanvasLimitLabel-<%= category.id %>">
            <div class="offcanvas-header">
              <h5 class="offcanvas-title" id="offcanvasLimitLabel-<%= category.id %>">Set Category Limit</h5>
            </div>
            <div class="offcanvas-body small pt-0 pb-4 px-2">
              <%= form_with model: category, url: update_budget_limit_path(category.id), method: :patch, local: true do |f| %>
                <div class="input-group mt-2">
                  <%= f.number_field :limit, placeholder: "Set limit", class: "form-control form-control-sm",  min: 0 %>
                  <button class="btn btn-outline-primary btn-sm" type="submit">Save</button>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
      <% if limit.present? %>
        <% remaining = [limit - total, 0].max %>
        <% percentage = [(total.to_f / limit) * 100, 100].min %>
        <div class="progress" style="height: 10px;">
          <div
            class="progress-bar"
            role="progressbar"
            style="width: <%= percentage %>%; background-color: <%= bar_color %>;"
            aria-valuenow="<%= percentage %>"
            aria-valuemin="0"
            aria-valuemax="100"
          ></div>
        </div>
        <div class="d-flex justify-content-between mt-1 small text-muted">
          <% if total >= limit %>
            <div style="color: #c10101ff">Total spent: ¥<%= number_with_delimiter(total)%> / ¥<%= number_with_delimiter(limit) || "" %></div>
          <% else %>
            <div style="color: #000000ff">Total spent: ¥<%= number_with_delimiter(total)%> / ¥<%= number_with_delimiter(limit) || "" %></div>
          <% end %>
        </div>
      <% else %>
        <div class="mt-1 small text-muted">
          <span style="color: #000000ff">Total spent – ¥<%= number_with_delimiter(total) %></span>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
